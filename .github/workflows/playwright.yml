name: Playwright Tests

on:
    schedule:
        - cron: '0 6 * * *'
    workflow_dispatch:
    push:
        branches: ['**']

jobs:
    run_tests:
        runs-on: ubuntu-latest
        container:
            image: mcr.microsoft.com/playwright:v1.51.1

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Debug test structure
              run: |
                  echo "Содержимое тестовой директории:"
                  find . -name "*.spec.ts" -o -name "*.test.ts" | xargs -I {} sh -c 'echo "Файл: {}"; head -n 10 {}'
                  echo "Поиск теста по ключевым словам:"
                  grep -r "Проверка работоспособности сайта 1tm.ru" . || echo "Тест не найден"

            - name: Install dependencies
              run: npm install

            - name: Verify test exists
              run: |
                  TEST_FILE=$(grep -rl "Проверка работоспособности сайта 1tm.ru" tests/ || echo "")
                  if [ -z "$TEST_FILE" ]; then
                    echo "::error::Тест не найден в проекте"
                    exit 1
                  fi
                  echo "Тест найден в файле: $TEST_FILE"

            - name: Run specific test
              run: |
                  npx playwright test \
                    --grep "Проверка работоспособности сайта 1tm.ru" \
                    --reporter=html,line \
                    --workers=1 \
                    --timeout=60000

            - name: Upload report
              if: always()
              uses: actions/upload-artifact@v3
              with:
                  name: playwright-report
                  path: playwright-report/
                  retention-days: 7

            - name: Show test results
              if: always()
              run: |
                  echo "### Результаты теста"
                  echo '```'
                  grep -A 10 "Проверка работоспособности сайта 1tm.ru" playwright-report/index.html | sed 's/<[^>]*>//g'
                  echo '```'
                  echo "[Открыть полный отчёт](https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)"
