name: Playwright tests with reliable HTML report

on:
    schedule:
        - cron: '0 6 * * *'
    workflow_dispatch:
    push:
        branches: ['**']

jobs:
    run_test:
        runs-on: ubuntu-latest
        container:
            image: mcr.microsoft.com/playwright:v1.51.1

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Install dependencies
              run: npm install

            - name: Run tests with HTML report
              run: |
                  mkdir -p playwright-report
                  npx playwright test \
                    --grep 'Проверка рабоспособности сайтов' \
                    --reporter=html \
                    --output=playwright-report \
                    || echo "Tests completed with status $?"

            - name: Verify report generation
              run: |
                  if [ ! -f "playwright-report/index.html" ]; then
                      echo "::error::HTML report was not generated!"
                      ls -la playwright-report/
                      exit 1
                  fi
                  echo "Report successfully generated"

            - name: Install zip if needed
              run: |
                  if ! command -v zip &> /dev/null; then
                      apt-get update && apt-get install -y zip
                  fi

            - name: Create report archive
              run: |
                  cd playwright-report && zip -r ../playwright-report.zip .

            - name: Upload report via API
              run: |
                  curl -X POST \
                    -H "Authorization: Bearer ${{ github.token }}" \
                    -H "Accept: application/vnd.github.v3+json" \
                    -H "Content-Type: application/zip" \
                    --data-binary @playwright-report.zip \
                    "https://uploads.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts?name=playwright-html-report" \
                    --fail || echo "API upload failed"

            - name: Provide download instructions
              run: |
                  echo "=============================================="
                  echo "HOW TO ACCESS THE HTML REPORT:"
                  echo "1. Go to https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  echo "2. Under 'Artifacts' section, download 'playwright-html-report'"
                  echo "3. Unzip and open 'index.html' in browser"
                  echo "=============================================="
                  echo "File size: $(du -h playwright-report.zip | cut -f1)"
                  echo "MD5 checksum: $(md5sum playwright-report.zip | cut -d' ' -f1)"
