name: Playwright Tests with Container Report

on:
    schedule:
        - cron: '0 6 * * *'
    workflow_dispatch:
    push:
        branches: ['**']

jobs:
    run_tests:
        runs-on: ubuntu-latest

        steps:
            # 1. Подготовка рабочей директории
            - name: Checkout code
              uses: actions/checkout@v4

            # 2. Создаём package-lock.json если его нет
            - name: Generate package-lock
              run: npm install --package-lock-only

            # 3. Запуск тестов в контейнере
            - name: Run tests in container
              run: |
                  docker run \
                    --shm-size=1gb \
                    -v $(pwd):/app \
                    -w /app \
                    mcr.microsoft.com/playwright:v1.51.1 \
                    /bin/bash -c "npm ci && npx playwright test --grep 'Проверка работоспособности сайта 1tm.ru' --reporter=html --output=playwright-report"
              continue-on-error: true

            # 4. Архивирование отчёта
            - name: Prepare report
              run: |
                  cd playwright-report && zip -r ../playwright-report.zip ./*

            # 5. Загрузка через GitHub API
            - name: Upload report
              run: |
                  curl -X POST \
                    -H "Authorization: Bearer ${{ github.token }}" \
                    -H "Accept: application/vnd.github.v3+json" \
                    -H "Content-Type: application/zip" \
                    --data-binary @playwright-report.zip \
                    "https://uploads.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts?name=playwright-html-report"

            # 6. Ссылка на отчёт
            - name: Show report URL
              run: |
                  echo "Отчёт доступен здесь:"
                  echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
